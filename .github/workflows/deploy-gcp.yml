name: Deploy KhananNetra Backend to GCP

on:
  push:
    branches:
      - main
      - deploy
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_ZONE: us-central1
  REGISTRY_HOSTNAME: gcr.io

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker to use the gcloud as a credential helper
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY_HOSTNAME }}

      - name: Build Docker images
        run: |
          docker-compose build

      - name: Push Node.js Backend to Container Registry
        run: |
          docker tag khanannetra-nodejs-backend ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-nodejs-backend:${{ github.sha }}
          docker tag khanannetra-nodejs-backend ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-nodejs-backend:latest
          docker push ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-nodejs-backend:${{ github.sha }}
          docker push ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-nodejs-backend:latest

      - name: Push Python Backend to Container Registry
        run: |
          docker tag khanannetra-python-backend ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-python-backend:${{ github.sha }}
          docker tag khanannetra-python-backend ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-python-backend:latest
          docker push ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-python-backend:${{ github.sha }}
          docker push ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-python-backend:latest

      - name: Deploy Node.js Backend to Cloud Run
        run: |
          gcloud run deploy khanannetra-nodejs-backend \
            --image ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-nodejs-backend:${{ github.sha }} \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=production,MONGODB_URI=${{ secrets.MONGODB_URI }},CLIENT_URL=${{ secrets.CLIENT_URL }},PYTHON_BACKEND_URL=${{ secrets.PYTHON_BACKEND_URL }},JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --memory 1Gi \
            --cpu 2 \
            --timeout 300s \
            --max-instances 10 \
            --min-instances 1

      - name: Deploy Python Backend to Cloud Run
        run: |
          gcloud run deploy khanannetra-python-backend \
            --image ${{ env.REGISTRY_HOSTNAME }}/${{ env.PROJECT_ID }}/khanannetra-python-backend:${{ github.sha }} \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --set-env-vars "KAGGLE_USERNAME=${{ secrets.KAGGLE_USERNAME }},KAGGLE_KEY=${{ secrets.KAGGLE_KEY }},KAGGLE_MODEL_PATH=${{ secrets.KAGGLE_MODEL_PATH }},MODEL_CACHE_DIR=/tmp/kagglehub,DOWNLOAD_MODELS_ON_STARTUP=true" \
            --memory 2Gi \
            --cpu 4 \
            --timeout 300s \
            --max-instances 5 \
            --min-instances 0

      - name: Notify Deployment Success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "Node.js Backend: https://khanannetra-nodejs-backend-xxxxx.a.run.app"
          echo "Python Backend: https://khanannetra-python-backend-xxxxx.a.run.app"
